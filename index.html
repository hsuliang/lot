<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ㄚ亮笑長的摸彩助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="pt-2 px-4 pb-16">

    <div id="app-bg-overlay" class="fixed inset-0 pointer-events-none bg-cover bg-center bg-no-repeat transition-opacity duration-500 opacity-0"></div>

    <div class="w-full max-w-5xl mx-auto relative z-10">
        <header class="text-center mt-2 mb-8"">
            <div class="relative flex flex-col md:flex-row items-center justify-center gap-2">
                
                <img id="logo-img" src="../Aliang.png" alt="Aliang Logo" class="h-14 md:h-20 w-auto object-contain flex-shrink-0" onerror="this.style.visibility='hidden';">

                <h1 id="main-title" class="text-5xl md:text-6xl font-bold izakaya-title">ㄚ亮笑長的摸彩助手</h1>
                
                <button id="reset-btn" class="absolute right-0 text-3xl p-2 rounded-full hidden hover:bg-white/10 transition-colors" style="color: var(--text-muted-color);" title="重置並返回設定">⟲</button>
            </div>
        </header>

        <section id="settings-section" class="space-y-6">
            
            <div class="card p-8 rounded-lg">
                 <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">環境設定</h2>
                 <div class="border-b" style="border-color: var(--input-border-color);">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                        <button id="tab-mode" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">模式設定</button>
                        <button id="tab-title" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">標題設定</button>
                        <button id="tab-prize" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">獎項設定</button>
                        <button id="tab-theme" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">布景主題</button>
                        <button id="tab-visual" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">自訂視覺</button>
                        <button id="tab-sound" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">音效開關</button>
                        <button id="tab-effect" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">特效設定</button>
                    </nav>
                </div>

                <div id="tab-content-mode" class="hidden mt-6 space-y-6">
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="font-semibold text-lg" style="color: var(--text-color);">啟用單純抽籤模式</span>
                            <span class="text-sm" style="color: var(--text-muted-color);">將隱藏獎項設定，變為純粹的抽籤工具。</span>
                        </div>
                        <label for="simple-draw-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="simple-draw-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 toggle-switch-bg peer-checked:bg-red-500"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="font-semibold text-lg" style="color: var(--text-color);">啟用多人/分次抽取功能</span>
                            <span class="text-sm" style="color: var(--text-muted-color);">點擊一次摸彩按鈕可同時抽出多位得獎者。</span>
                        </div>
                        <label for="batch-draw-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="batch-draw-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 toggle-switch-bg peer-checked:bg-red-500"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="font-semibold text-lg" style="color: var(--text-color);">過濾重複姓名</span>
                            <span class="text-sm" style="color: var(--text-muted-color);">讀取名單時檢查是否有重複人名。</span>
                        </div>
                        <label for="filter-duplicates-toggle" class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="filter-duplicates-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 toggle-switch-bg peer-checked:bg-red-500"></div>
                        </label>
                    </div>
                </div>

                <div id="tab-content-title" class="hidden mt-6 space-y-4">
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">儲存目前標題為範本</label>
                        <div class="flex gap-2">
                            <input type="text" id="title-template-name-input" class="form-input w-full p-2 rounded" placeholder="請輸入範本名稱">
                            <button id="save-title-template-btn" class="btn-primary px-4 py-2 rounded-lg text-sm flex-shrink-0">儲存</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">載入標題範本</label>
                        <div id="title-template-buttons-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <hr style="border-color: var(--input-border-color);" class="my-4">
                    <div>
                        <label for="title-input" class="block mb-1 font-semibold" style="color: var(--accent-color);">摸彩活動標題</label>
                        <input type="text" id="title-input" class="form-input w-full p-2 rounded" placeholder="請輸入新的標題">
                    </div>
                </div>
                
                <div id="tab-content-prize" class="hidden mt-6">
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">儲存目前獎項為範本</label>
                        <div class="flex gap-2">
                            <input type="text" id="template-name-input" class="form-input w-full p-2 rounded" placeholder="請輸入範本名稱">
                            <button id="save-template-btn" class="btn-primary px-4 py-2 rounded-lg text-sm flex-shrink-0">儲存</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">載入獎項範本</label>
                        <div id="template-buttons-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <hr style="border-color: var(--input-border-color);" class="my-4">
                    <div id="prizes-container" class="space-y-3"></div>
                    <div class="flex gap-4 mt-4">
                        <button id="add-prize-btn" class="w-full btn-secondary py-2 rounded-lg text-lg font-bold">＋ 新增獎項</button>
                        <button id="clear-prizes-btn" class="w-full btn-secondary py-2 rounded-lg text-lg font-bold" style="background-color: var(--danger-color);">清空獎項</button>
                    </div>
                </div>
                
                <div id="tab-content-theme" class="hidden mt-6">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-lg" style="color: var(--text-color);">選擇一個您喜歡的風格</span>
                        <div id="theme-selector" class="flex items-center justify-center gap-3"></div>
                    </div>
                </div>

                <div id="tab-content-visual" class="hidden mt-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block mb-2 font-semibold" style="color: var(--accent-color);">自訂標誌 (Logo)</label>
                            <input type="file" id="logo-upload" class="form-input w-full p-2 rounded" accept="image/*">
                            <button id="reset-logo-btn" class="mt-2 text-sm underline" style="color: var(--text-muted-color);">恢復預設 Logo</button>
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold" style="color: var(--accent-color);">自訂背景圖</label>
                            <input type="file" id="bg-upload" class="form-input w-full p-2 rounded" accept="image/*">
                            <button id="reset-bg-btn" class="mt-2 text-sm underline" style="color: var(--text-muted-color);">移除自訂背景</button>
                        </div>
                    </div>
                </div>

                <div id="tab-content-sound" class="hidden mt-6">
                    <div class="flex items-center justify-between">
                         <span class="font-semibold text-lg" style="color: var(--text-color);">點擊圖示以開啟或關閉音效</span>
                         <button id="sound-toggle-btn" class="text-3xl p-2 rounded-full transition-colors duration-300 hover:bg-white/10" aria-label="切換音效">🔊</button>
                    </div>
                </div>

                <div id="tab-content-effect" class="hidden mt-6">
                    <div>
                        <label for="winner-effect-select" class="block mb-2 font-semibold" style="color: var(--accent-color);">中獎動畫特效</label>
                        <select id="winner-effect-select" class="form-input w-full p-2 rounded">
                            <option value="none">標準效果</option>
                            <option value="spotlight">聚光燈效果</option>
                            <option value="marquee">文字跑馬燈</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card p-8 rounded-lg">
                <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">名單設定</h2>
                <div class="border-b" style="border-color: var(--input-border-color);">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                        <button id="tab-custom" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                            自訂名單
                        </button>
                        <button id="tab-cloud" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                            共用連結
                        </button>
                        <button id="tab-csv" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                            雲端名單
                        </button>
                        <button id="tab-exclude" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                            排除人員
                        </button>
                    </nav>
                </div>
                
                <div id="tab-content-custom" class="hidden mt-6 space-y-4">
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">儲存目前名單為範本</label>
                        <div class="flex gap-2">
                            <input type="text" id="list-template-name-input" class="form-input w-full p-2 rounded" placeholder="請輸入範本名稱">
                            <button id="save-list-template-btn" class="btn-primary px-4 py-2 rounded-lg text-sm flex-shrink-0">儲存</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">載入名單範本</label>
                        <div id="list-template-buttons-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <hr style="border-color: var(--input-border-color);" class="my-4">
                     <div>
                        <label for="custom-list" class="block mb-1 font-semibold" style="color: var(--accent-color);">參與人員名單</label>
                        <textarea id="custom-list" rows="6" class="form-input w-full p-2 rounded" placeholder="請在此輸入名單..."></textarea>
                        <p class="text-sm mt-2" style="color: var(--text-muted-color);">提示：一行一個名字，或用半形逗號「,」隔開。</p>
                    </div>
                </div>

                <div id="tab-content-cloud" class="hidden mt-6">
                    <div class="space-y-4">
                        <div>
                            <label for="sheet-url" class="block mb-1 font-semibold" style="color: var(--accent-color);">Google 試算表「共用」網址</label>
                            <input type="url" id="sheet-url" class="form-input w-full p-2 rounded" placeholder="貼上「知道連結的任何人」權限的共用連結">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="sheet-name" class="block mb-1 font-semibold" style="color: var(--accent-color);">工作表名稱</label>
                                <input type="text" id="sheet-name" class="form-input w-full p-2 rounded" value="工作表1">
                            </div>
                            <div>
                                <label for="column-letter" class="block mb-1 font-semibold" style="color: var(--accent-color);">名單在哪一欄？</label>
                                <input type="text" id="column-letter" maxlength="2" class="form-input w-full p-2 rounded" value="A" placeholder="A, B, C...">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-content-csv" class="hidden mt-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="csv-url-input" class="block mb-1 font-semibold" style="color: var(--accent-color);">Google 試算表「發布到網路」的 CSV 網址</label>
                            <input type="url" id="csv-url-input" class="form-input w-full p-2 rounded" placeholder="貼上 .../pub?output=csv 格式的網址">
                        </div>
                        <div>
                            <label for="csv-column-letter" class="block mb-1 font-semibold" style="color: var(--accent-color);">名單在哪一欄？</label>
                            <input type="text" id="csv-column-letter" maxlength="2" class="form-input w-full p-2 rounded" value="A" placeholder="A, B, C...">
                        </div>
                    </div>
                    <div>
                        <details>
                            <summary style="cursor: pointer; color: var(--accent-color);">如何取得「發布到網路」的 CSV 網址？</summary>
                            <div class="mt-2 text-sm space-y-1 p-3 rounded-md" style="background-color: var(--input-bg); color: var(--text-muted-color);">
                                <p>1. 在您的 Google 試算表中，點擊左上角選單：<strong>檔案</strong> > <strong>分享</strong> > <strong>發布到網路</strong>。</p>
                                <p>2. 在跳出的視窗中，確認左邊選擇的是「<strong>連結</strong>」分頁。</p>
                                <p>3. 在第一個下拉選單，請選擇您存放名單的那個「<strong>工作表</strong>」。</p>
                                <p>4. 在第二個下拉選單，請務必將格式改為「<strong>逗號分隔 (.csv)</strong>」。</p>
                                <p>5. 點擊綠色的「<strong>發布</strong>」按鈕，並在確認視窗中點擊「確定」。</p>
                                <p>6. 複製下方產生的網址，並將它貼到上方的輸入框中即可。</p>
                            </div>
                        </details>
                    </div>
                </div>

                <div id="tab-content-exclude" class="hidden mt-6 space-y-4">
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">儲存排除名單為範本</label>
                        <div class="flex gap-2">
                            <input type="text" id="exclude-template-name-input" class="form-input w-full p-2 rounded" placeholder="請輸入排除範本名稱">
                            <button id="save-exclude-template-btn" class="btn-primary px-4 py-2 rounded-lg text-sm flex-shrink-0">儲存</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold" style="color: var(--accent-color);">載入排除範本</label>
                        <div id="exclude-template-buttons-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <hr style="border-color: var(--input-border-color);" class="my-4">
                     <div>
                        <label for="exclude-list" class="block mb-1 font-semibold" style="color: var(--accent-color);">排除名單 (不具備摸彩資格人員)</label>
                        <textarea id="exclude-list" rows="6" class="form-input w-full p-2 rounded" placeholder="請輸入要排除的名字..."></textarea>
                        <p class="text-sm mt-2" style="color: var(--text-muted-color);">提示：這些人將不會被載入抽獎池。一行一個名字，或用半形逗號「,」隔開。</p>
                    </div>
                </div>

            </div>

            <div class="mt-8 space-y-4">
                <button id="load-button" class="w-full btn-primary py-3 rounded-lg text-xl font-bold shadow-lg">載入名單並開始</button>
            </div>

            <p id="status-message" class="text-center mt-4 h-6" style="color: var(--accent-color);"></p>
        </section>

        <section id="lottery-section" class="hidden flex flex-col md:flex-row gap-6 items-start">
            <div id="main-draw-panel" class="w-full md:w-full card p-8 rounded-lg">
                 <div class="flex flex-col sm:flex-row justify-end items-center mb-4 gap-2">
                     <p><span id="participant-label">剩餘摸彩人數</span>: <span id="participant-count" class="font-bold text-2xl" style="color: var(--accent-color);">0</span></p>
                </div>
                <h3 id="current-prize-display" class="text-3xl text-center mb-4 font-bold" style="color: var(--accent-color);"></h3>
                <div id="winner-display" class="winner-display rounded-lg p-4 mb-6 text-4xl md:text-6xl text-center">
                    準備開始！
                </div>

                <div id="batch-settings" class="mb-6 flex flex-col items-center justify-center gap-2 hidden">
                    <div class="flex items-center gap-3">
                        <label for="batch-size-input" class="font-semibold" style="color: var(--text-muted-color);">本次抽出人數:</label>
                        <input type="number" id="batch-size-input" class="form-input w-20 text-center text-xl p-1 rounded-lg" value="1" min="1" max="100">
                    </div>
                    <p class="text-xs" style="color: var(--text-muted-color);">提示：若剩餘獎項不足，將自動調整數量</p>
                </div>

                <div class="flex gap-4">
                    <button id="draw-button" class="btn-primary w-full py-4 rounded-lg text-2xl font-bold shadow-xl">開始摸彩</button>
                </div>
            </div>
             <div id="winners-list-container" class="w-full md:w-[30%] hidden">
                <div class="card p-6 rounded-lg">
                    <h3 id="winners-list-title" class="text-xl font-bold text-center mb-4" style="color: var(--accent-color);">🎉 得獎名單 🎉</h3>
                    <div id="winners-list" class="space-y-4 text-center text-lg">
                    </div>
                    <button id="export-csv-btn" class="hidden mt-4 btn-secondary w-full py-3 rounded-lg text-xl font-bold">匯出得獎名單</button>
                </div>
            </div>
        </section>
        
    </div>
     <audio id="rolling-sound" src="https://hsuliang.github.io/rool5.mp3" preload="auto" loop></audio>
    <audio id="winner-sound" src="https://hsuliang.github.io/happy.mp3" preload="auto"></audio>
    
    <footer class="fixed bottom-0 left-0 right-0 p-3 text-center text-xs backdrop-blur-sm" style="color: var(--text-muted-color); background-color: var(--footer-bg);">
        <span>v2.9.0@2025/12/27</span> |
        <span>由 Google Gemini 強力驅動</span> |
        <a href="https://bit.ly/Alaing" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors">ㄚ亮笑長練功坊</a>
    </footer>

    <div id="duplicates-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black/70 backdrop-blur-sm p-4">
        <div class="card max-w-lg w-full p-8 rounded-lg shadow-2xl">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">發現重複名單</h2>
            <div id="duplicates-list" class="max-h-60 overflow-y-auto mb-6 p-4 rounded bg-black/20 space-y-2">
                <!-- 重複清單會顯示在這裡 -->
            </div>
            <div class="flex flex-col gap-3">
                <div class="grid grid-cols-2 gap-3">
                    <button id="dup-delete-all-btn" class="btn-secondary py-3 rounded-lg font-bold" style="background-color: var(--danger-color); color: white;">全部刪除</button>
                    <button id="dup-keep-one-btn" class="btn-primary py-3 rounded-lg font-bold">留下一個</button>
                </div>
                <button id="dup-cancel-btn" class="w-full btn-secondary py-2 rounded-lg" style="color: var(--text-muted-color);">取消並手動修改</button>
            </div>
        </div>
    </div>

    <div id="recovery-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden bg-black/80 backdrop-blur-md p-4">
        <div class="card max-w-md w-full p-8 rounded-lg shadow-2xl text-center border-2" style="border-color: var(--accent-color);">
            <div class="text-5xl mb-4">回覆提醒</div>
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">偵測到未完成的活動</h2>
            <p class="mb-8" style="color: var(--text-color);">系統發現您上次有尚未結束的抽獎進度，請問要恢復繼續抽獎，還是重新開始新活動？</p>
            <div class="flex flex-col gap-3">
                <button id="resume-session-btn" class="btn-primary py-4 rounded-lg text-xl font-bold shadow-lg">恢復進度 (繼續抽)</button>
                <button id="download-session-btn" class="btn-secondary py-3 rounded-lg font-bold" style="background-color: #2d3748; color: var(--accent-color); border: 1px solid var(--accent-color);">下載進度明細 (CSV)</button>
                <button id="discard-session-btn" class="btn-secondary py-3 rounded-lg font-bold" style="color: var(--text-muted-color);">放棄並重新開始</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>